## 开发规范

- 文档放在 docs 目录
- 查看 @README.md 了解项目概述
- **统一工作流程** @docs/TDD-GIT-WORKFLOW.md - TDD + Git Flow 集成开发流程
- 测试流程 @docs/TESTING.md
- 架构文档 @docs/ARCHITECTURE.md
- API 设计 @docs/API.md
- 性能测试 @docs/PERFORMANCE.md

## TDD + Git 工作流程

当我们开始开发一个新功能时，请遵循 **TDD + Git 统一工作流程**：

### 开发循环
1. **Red Phase** (`make tdd-red`): 编写失败测试
2. **Green Phase** (`make tdd-green`): 最小实现通过测试
3. **Refactor Phase** (`make tdd-refactor`): 重构优化代码
4. **Git Commit** (`make tdd-commit`): 提交绿色状态

### 快速命令
- `make status-check` - 检查当前TDD状态
- `make tdd-full` - 智能TDD循环
- `make pre-commit-check` - 提交前质量检查

### 开发规范
- 先更新相关的文档，我确认过后再开始执行
- 严格遵循 TDD 红绿重构循环
- 只有绿色状态才能提交到Git
- Readme.md 使用中文，注释使用英文
- 错误需要用 thiserror ✅ (已完成)
- 统一使用 tracing 日志库，不使用 log 库（更适合分布式系统）

## 调试规范

- 使用 LLDB MCP 的调试解决问题

## 测试规范

- 注意测试请求相应和发布订阅模式的时候应该用不同的进程

## Claude 斜杠命令

### /tdd - 智能TDD循环

智能分析当前项目状态，自动执行合适的TDD阶段：

```
/tdd
```

**智能行为逻辑**:
1. **状态检测** - 分析Git状态、测试状态、代码质量
2. **阶段判断** - 自动选择Red/Green/Refactor阶段
3. **自动执行** - 运行相应的TDD操作
4. **进度跟踪** - 更新TodoWrite任务状态
5. **下一步建议** - 提供明确的后续操作指导

**输出示例**:
```
🔄 智能TDD循环分析...
📊 当前状态: Green (测试通过)
🎯 建议操作: Refactor (重构优化)
⚡ 自动执行: 代码质量检查和重构
✅ 重构完成，代码质量提升
💡 下一步: 运行 /commit 提交绿色状态
```

### TDD专用命令

#### /tdd-red - 红色阶段
```
/tdd-red
```
- 检查语法错误
- 准备编写失败测试
- 提供测试编写指导

#### /tdd-green - 绿色阶段  
```
/tdd-green
```
- 运行测试验证
- 确保测试通过
- 进入绿色状态

#### /tdd-refactor - 重构阶段
```
/tdd-refactor
```
- 保持测试通过
- 运行代码质量检查  
- 格式化代码
- 优化代码结构

#### /tdd-status - 状态检查
```
/tdd-status
```
- 检查Git工作状态
- 分析测试运行状态
- 提供TDD阶段建议
- 显示待办任务进度

### 与现有命令集成

- **质量检查**: `/tdd` 自动集成 `/check` 命令逻辑
- **Git提交**: TDD绿色状态后建议使用 `/commit`
- **任务管理**: 自动同步TodoWrite任务状态
- **错误恢复**: 智能处理常见TDD流程问题

### TDD命令使用场景

1. **开始新功能**: `/tdd-red` → 编写失败测试
2. **实现功能**: `/tdd-green` → 最小代码实现  
3. **代码优化**: `/tdd-refactor` → 重构和质量提升
4. **日常开发**: `/tdd` → 智能检测当前状态并执行
5. **状态检查**: `/tdd-status` → 了解当前TDD进度

### 错误处理和恢复

- **编译错误**: 自动检测语法问题并提供修复建议
- **测试失败**: 分析失败原因，提供调试指导
- **质量问题**: 自动运行clippy和fmt修复常见问题
- **Git状态**: 检测工作目录状态，避免冲突

**使用建议**:
- 优先使用 `/tdd` 让Claude智能判断当前状态
- 在特定场景下使用专用命令强制进入某个阶段
- 结合 `/tdd-status` 随时了解项目TDD进度
- 完成TDD循环后使用 `/commit` 提交绿色状态

## 智能TDD逻辑设计

### 状态检测算法

智能TDD系统通过以下检测机制判断当前状态：

#### 1. Git状态分析
```
检查项                     | 状态判断
---------------------------|------------------
git diff --quiet          | 工作目录是否干净
git status --porcelain    | 暂存区状态
git log --oneline -1       | 最近提交信息
```

#### 2. 测试状态分析  
```
检查项                              | 状态判断
------------------------------------|------------------
cargo test --test rpc_tdd_test     | 核心测试是否通过
cargo check --all-targets          | 语法是否正确
最近测试运行结果                     | 测试趋势分析
```

#### 3. 代码质量分析
```
检查项                        | 状态判断
------------------------------|------------------
cargo clippy --all-targets   | 代码质量问题
cargo fmt --check            | 格式是否规范
TODO注释数量                   | 待办事项状态
```

### TDD阶段决策树

```
开始检测
    │
    ├─ 语法错误? ──→ 🔴 提示修复语法错误
    │
    ├─ 测试失败? ──→ 分析失败原因
    │    ├─ 新功能测试 ──→ 🟢 Green Phase (实现功能)
    │    └─ 回归测试   ──→ 🚨 修复回归问题
    │
    ├─ 测试通过? ──→ 检查代码质量
    │    ├─ 质量问题 ──→ ♻️ Refactor Phase (重构)
    │    ├─ 无修改   ──→ 🔴 Red Phase (新测试)
    │    └─ 有修改   ──→ 📝 建议提交
    │
    └─ 无测试? ────→ 🔴 Red Phase (编写测试)
```

### 智能建议系统

#### 情况1: 🔴 Red Phase 建议
```
触发条件: 测试全部通过 + 工作目录干净
建议操作: 
- 编写新功能的失败测试
- 添加边界情况测试
- 增加错误处理测试
- 提供测试模板和示例
```

#### 情况2: 🟢 Green Phase 建议  
```
触发条件: 有测试失败 + 是新功能测试
建议操作:
- 实现最小代码使测试通过
- 避免过度设计
- 专注于测试要求
- 保持其他测试通过
```

#### 情况3: ♻️ Refactor Phase 建议
```
触发条件: 测试通过 + 有代码质量问题
建议操作:
- 修复clippy警告
- 优化代码结构
- 改进变量命名
- 添加文档注释
- 重构重复代码
```

#### 情况4: 📝 Commit Phase 建议
```
触发条件: 测试通过 + 代码质量良好 + 有修改
建议操作:
- 运行完整测试套件
- 检查提交信息规范
- 确保符合项目约定
- 执行 /commit 命令
```

### 错误模式识别与恢复

#### 常见错误模式

1. **编译错误循环**
   - 检测: 连续语法检查失败
   - 恢复: 回滚到最近可编译状态，分步修复

2. **测试无限失败**  
   - 检测: 同一测试连续失败超过阈值
   - 恢复: 分析错误模式，提供调试建议

3. **重构破坏测试**
   - 检测: 重构后测试从通过变为失败
   - 恢复: 建议回滚重构，使用更小步骤

4. **Git状态混乱**
   - 检测: 工作目录和暂存区状态不一致
   - 恢复: 提供Git状态清理建议

### 自动化操作矩阵

| 当前状态 | 检测条件 | 自动操作 | 用户确认 |
|----------|----------|----------|----------|
| 🔴 Red | 语法错误 | 运行cargo check | 否 |
| 🟢 Green | 测试失败 | 运行cargo test | 否 |  
| ♻️ Refactor | 质量问题 | 运行cargo clippy + fmt | 是 |
| 📝 Commit | 绿色状态 | 准备Git暂存 | 是 |
| 🚨 Error | 状态异常 | 提供恢复建议 | 是 |

### 进度跟踪机制

#### TodoWrite集成
- 自动创建TDD阶段对应的todo任务
- 实时更新任务状态(pending/in_progress/completed)
- 关联具体的测试用例和代码修改
- 生成TDD循环完成报告

#### 状态持久化
- 记录每次TDD循环的状态转换
- 跟踪测试覆盖率变化
- 监控代码质量指标趋势
- 分析开发效率指标

**实现优先级**:
1. **高**: 基础状态检测和阶段判断
2. **中**: 智能建议和错误恢复  
3. **低**: 高级分析和趋势跟踪
